<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SafeStep — Latest Alert</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; }
    .muted { color: #666; font-size: 12px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; background: #fafafa; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    td { border: 1px solid #ddd; padding: 6px 10px; }
    .msg { white-space: pre-wrap; background: #fff; border: 1px solid #eee; padding: 8px; border-radius: 8px; }
    button { padding: 8px 12px; border-radius: 10px; border: 1px solid #ccc; background: #f5f5f5; cursor: pointer; margin-right: 8px; }
  </style>
</head>
<body>
  <h1>SafeStep — Latest Alert</h1>
  <div class="muted">This page shows the most recent alert only (no database). It may clear on cold start.</div>
  <div style="margin:12px 0;">
    <button id="refresh">Refresh</button>
    <label class="muted">Auto-refresh <input type="checkbox" id="auto" checked> every 10s</label>
  </div>

  <div id="content" class="card">Loading…</div>

<script>
async function load() {
  const box = document.getElementById('content');
  box.textContent = 'Loading…';
  try {
    const r = await fetch('/api/last', { cache: 'no-store' });
    const j = await r.json();
    const e = j.last;
    if (!e) { box.textContent = 'No alerts yet (or server cold start).'; return; }

    const lines = [];
    const m = e.metrics || {};
    if (m.tempC != null || m.tempF != null) lines.push(`${m.tempC?.toFixed?.(2)} °C / ${m.tempF?.toFixed?.(2)} °F`);
    if (m.humidity != null)  lines.push(`${m.humidity.toFixed?.(2)} %`);
    if (m.steps != null)     lines.push(`${m.steps} steps`);
    if (m.heartRate != null) lines.push(`${m.heartRate.toFixed?.(1)} bpm`);

    box.innerHTML = `
      <div><b>When (server):</b> ${new Date(e.receivedAt).toLocaleString()}</div>
      <div><b>Event:</b> ${e.event}</div>
      <table>
        ${lines.length ? `<tr><td><b>Vitals</b></td><td>${lines.join('<br>')}</td></tr>` : ''}
        <tr><td><b>Message</b></td><td class="msg">${(e.msg||'').replace(/\n/g,'<br>')}</td></tr>
      </table>
    `;
  } catch (err) {
    box.textContent = 'Error: ' + err.message;
  }
}

document.getElementById('refresh').addEventListener('click', load);
let timer = null;
document.getElementById('auto').addEventListener('change', e => {
  if (e.target.checked) { load(); timer = setInterval(load, 10000); }
  else { clearInterval(timer); timer = null; }
});
load();
timer = setInterval(load, 10000);
</script>
</body>
</html>